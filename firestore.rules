rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

  function signedIn() { return request.auth != null; }
  function uid() { return request.auth.uid; }
  function role() { return request.auth.token.role; }
  function isAdmin() { return signedIn() && role() == "admin"; }
  function isTutor() { return signedIn() && (role() == "tutor" || role() == "admin"); }
  function isStudent() { return signedIn() && (role() == "student" || role() == "admin"); }

    match /users/{userId} {
      allow read: if signedIn() && (uid() == userId || isTutor() || isAdmin());
      allow create: if signedIn() && uid() == userId;
      allow update: if signedIn() && uid() == userId;
      allow delete: if isAdmin();
    }

    match /curriculumPrograms/{id} { allow read: if signedIn(); allow write: if isTutor(); }
    match /curriculumLevels/{id}   { allow read: if signedIn(); allow write: if isTutor(); }
    match /questTemplates/{id}     { allow read: if signedIn(); allow write: if isTutor(); }
    match /challengeTemplates/{id} { allow read: if signedIn(); allow write: if isTutor(); }
    match /standards/{id}          { allow read: if signedIn(); allow write: if isTutor(); }
    match /badgeTemplates/{id}     { allow read: if signedIn(); allow write: if isTutor(); }

    match /questInstances/{id} {
      allow read: if signedIn();
      allow create: if isTutor();
      allow update: if signedIn() && (
        isTutor() || (
          isStudent()
          && request.resource.data.studentUid == uid()
          && request.resource.data.diff(resource.data).changedKeys().hasOnly(['status', 'progress'])
          && request.resource.data.progress.mastered == resource.data.progress.mastered
          && request.resource.data.progress.tutorConfirmed == resource.data.progress.tutorConfirmed
        )
      );
      allow delete: if isTutor();
    }

    match /challengeInstances/{id} {
      allow read: if signedIn();
      allow create: if isTutor();
      allow update: if signedIn() && (
        isTutor() || (
          isStudent()
          && request.resource.data.studentUid == uid()
          && request.resource.data.diff(resource.data).changedKeys().hasOnly(['status', 'completedAt', 'evidence'])
        )
      );
      allow delete: if isTutor();
    }

    match /submissions/{id} {
      allow create: if isStudent() && request.resource.data.studentUid == uid();
      allow read: if signedIn();
      allow update, delete: if isTutor();
    }

    match /xpEvents/{id} {
      allow read: if signedIn();
      allow create: if isTutor() && request.resource.data.xp > 0;
      allow update, delete: if false;
    }

    match /badgesEarned/{id} {
      allow read: if signedIn();
      allow create: if isTutor();
      allow update, delete: if false;
    }

    match /{document=**} {
      allow read, write: if false;
    }
  }
}